<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>新无敌绿宝书N2单词练习</title>
    <script src="./tailwind.css"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 优化暗模式和通用样式 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
            overscroll-behavior-y: contain;
        }

        /* 优化暗模式背景和文本 */
        body.dark-mode {
            background: linear-gradient(135deg, #1a2634 0%, #2c3e50 100%);
            color: #e2e8f0;
        }

        /* 容器元素适配暗模式 */
        .header, .controls, .quiz-container {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .header,
        body.dark-mode .controls,
        body.dark-mode .quiz-container {
            background: rgba(45, 55, 72, 0.95);
            border-color: rgba(255, 255, 255, 0.3);
            color: #e2e8f0;
        }

        body.dark-mode .controls .bg-white {
            background: rgba(255, 255, 255, 0.1);    
        }

        dark:bg-indigo-900{
            background: rgba(255, 255, 255, 0.1); 
        }

        /* 渐变文本 */
        .gradient-text {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.dark-mode .gradient-text {
            /*background: linear-gradient(45deg, #93c5fd, #c4b5fd);*/
        }

        /* 按钮悬停效果 */
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        body.dark-mode .btn::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .btn:hover::before {
            left: 100%;
        }

        /* 退出按钮样式优化 */
        .exit-btn {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 0.75rem);
            right: 0.75rem;
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(to bottom right, #e5e7eb, #d1d5db);
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 50;
        }

        body.dark-mode .exit-btn {
            background: linear-gradient(to bottom right, #4b5563, #6b7280);
            color: #e2e8f0;
        }

        .exit-btn:hover {
            background: linear-gradient(to bottom right, #d1d5db, #b3b7c1);
            transform: scale(1.05);
        }

        body.dark-mode .exit-btn:hover {
            background: linear-gradient(to bottom right, #6b7280, #9ca3af);
        }

        .exit-btn:active {
            transform: scale(0.95);
        }

        /* 主题切换ボタン样式 */
        .theme-toggle {
            z-index: 50;
        }

        /* 在测验模式下隐藏主题切换按钮 */
        body.quiz-mode-active .theme-toggle {
            display: none !important;
        }

        /* 进度条动画 */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 30px 30px;
            animation: move 2s linear infinite;
        }

        body.dark-mode .progress-bar {
            background: #4b5563;
        }

        body.dark-mode .progress-fill {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
        }

        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 30px 30px; }
        }

        /* 选项悬停效果 */
        .option {
            background: rgba(255, 255, 255, 0.8);
            border-color: #93c5fd;
        }

        body.dark-mode .option {
            background: rgba(55, 65, 81, 0.8);
            border-color: #60a5fa;
            color: #e2e8f0;
        }

        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        body.dark-mode .option::before {
            background: linear-gradient(90deg, transparent, rgba(147, 197, 253, 0.2), transparent);
        }

        .option:hover::before {
            left: 100%;
        }

        /* 关键帧动画 */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Removed slideIn animation definition as it's no longer used for question text */
        /*
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        */
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 沉浸式测验视图 */
        body.quiz-mode-active .container {
            padding: 0;
            max-width: 100%;
            height: 100dvh;
            display: flex;
        }

        #quizContainer.immersive-active {
            width: 100%;
            height: 100dvh;
            min-height: 100dvh;
            margin: 0 !important;
            border-radius: 0;
            box-shadow: none;
            padding-top: calc(env(safe-area-inset-top, 0px) + 1.5rem) !important;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 3rem) !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }

        #quizContainer.immersive-active > div:not(.progress-container):not(.stats):not(.options):not(.feedback):not(.question-area-wrapper) {
            flex-grow: 1; /* Adjust if needed */
        }
        
        #quizContainer.immersive-active .question-area-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }


        #quizContainer.immersive-active .options {
            margin-top: auto;
            padding-bottom: 2rem;
            width: 100%;
        }

        #quizContainer.immersive-active .feedback {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 1.5rem);
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            margin-top: 0;
            margin-bottom: 0;
            z-index: 100;
            visibility: hidden;
        }


        /* 隐藏测验时的头部和控制区域 */
        .header.hidden-during-quiz,
        .controls.hidden-during-quiz {
            display: none !important;
        }

        /* -- START: Enhanced Feedback Styles -- */
        .feedback {
            text-align: center;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.2s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            word-break: break-word;
            color: #374151; /* Tailwind gray-700, base for feedback text */
        }

        body.dark-mode .feedback.text-green-600 { 
            color: #6ee7b7;
            background-color: rgba(16, 185, 129, 0.8);
            border-color: rgba(52, 211, 153, 0.5);
            box-shadow: 0 4px 12px rgba(52, 211, 153, 0.25);
        }

        body.dark-mode .feedback.text-red-600 {
            color: #fca5a5;
            background-color: rgba(220, 38, 38, 0.8);
            border-color: rgba(248, 113, 113, 0.5);
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.25);
        }

        body.dark-mode .glass-morphism {
            background: rgba(45, 55, 72, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .feedback small {
            display: block;
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        /* -- END: Enhanced Feedback Styles -- */


        /* 优化统计信息颜色 */
        body.dark-mode .stats .score.text-green-600 {
            color: #34d399;
        }

        body.dark-mode .stats .streak-counter.text-red-500 {
            color: #f87171;
        }

        body.dark-mode .stats .timer.text-orange-500 {
            color: #fb923c;
        }

        /* 优化问题文本颜色 */
        body.dark-mode .question.text-gray-900 {
            color: #e2e8f0;
        }
        body.dark-mode #exampleSentenceDisplay {
            color: #cbd5e1; /* slate-300 for dark mode example sentence */
        }

        /* 优化选项选择颜色 */
        body.dark-mode .option.bg-gradient-to-br.from-indigo-500.to-purple-600 {
            background: linear-gradient(to bottom right, #60a5fa, #a78bfa);
        }

        body.dark-mode .option.bg-gradient-to-br.from-green-500.to-lime-600 {
            background: linear-gradient(to bottom right, #34d399, #86efac);
        }

        body.dark-mode .option.bg-gradient-to-br.from-red-500.to-orange-500 {
            background: linear-gradient(to bottom right, #f87171, #fb923c);
        }

        /* 提示样式优化 */
        #keyboardHint {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem);
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 50;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 relative">
    <button class="theme-toggle fixed top-5 right-5 bg-white bg-opacity-90 rounded-full w-12 h-12 flex items-center justify-center text-2xl cursor-pointer shadow-md transition-all duration-300 hover:scale-110 hover:shadow-lg z-50" onclick="toggleTheme()">🌙</button>

    <div class="container mx-auto p-5 max-w-4xl">
        <div class="header bg-white bg-opacity-95 backdrop-blur-md rounded-2xl p-8 mb-8 text-center shadow-lg border border-white border-opacity-20 animate-[slideDown_0.8s_ease]">
            <h1 class="text-4xl font-bold mb-2 gradient-text">「無敵緑宝書」の語彙練習</h1>
            <p class="text-gray-600 text-lg">日本語能力試験スタイル語彙練習</p>
        </div>

        <div class="controls bg-white bg-opacity-95 backdrop-blur-md rounded-xl p-5 mb-8 flex flex-wrap gap-4 items-center justify-center shadow-lg border border-white border-opacity-20 animate-[slideUp_0.8s_ease]">
            <div class="lesson-selector flex items-center gap-2">
                <label for="lesson" class="font-semibold text-indigo-600">レッスン:</label>
                <select id="lesson" class="p-2.5 rounded-lg border-2 border-indigo-300 bg-white text-base cursor-pointer transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
                    <option value="all">全てのレッスン</option>
                    <!-- Lesson options will be populated by JavaScript -->
                </select>
            </div>
            <div class="mode-selector flex items-center gap-2">
                <label for="mode" class="font-semibold text-indigo-600">練習モード:</label>
                <select id="mode" class="p-2.5 rounded-lg border-2 border-indigo-300 bg-white text-base cursor-pointer transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
                    <option value="reading">読み方</option>
                    <option value="meaning">意味</option>
                    <option value="usage">使い方</option>
                    <option value="mixed">ミックス</option>
                </select>
            </div>
            <div class="difficulty-selector flex items-center gap-2">
                <label for="difficulty" class="font-semibold text-indigo-600">問題数:</label>
                <select id="difficulty" class="p-2.5 rounded-lg border-2 border-indigo-300 bg-white text-base cursor-pointer transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
                    <option value="5">5問</option>
                    <option value="10">10問</option>
                    <option value="20" selected>20問</option>
                    <option value="30">30問</option>
                    <option value="all">全て</option>
                </select>
            </div>
            <div>
                <button id="startQuizButton" class="btn relative overflow-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed" onclick="startQuiz()" disabled>練習開始</button>
                <button class="btn secondary relative overflow-hidden bg-gradient-to-br from-red-500 to-orange-500 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed" onclick="resetQuiz()">リセット</button>
            </div>
        </div>

        <div class="quiz-container bg-opacity-95 backdrop-blur-md rounded-2xl p-10 shadow-lg border border-white border-opacity-20 min-h-[400px] animate-[fadeIn_0.5s_ease]" id="quizContainer">
            <div class="welcome-message">
                <h2 class="text-center text-2xl font-bold mb-5">練習モードを選んで開始してください</h2>
                <p class="text-center text-gray-600 text-lg mb-8">
                    <strong>読み方:</strong> 漢字の読みを選択 (クリックで例文表示)<br>
                    <strong>意味:</strong> 単語の意味を選択<br>
                    <strong>使い方:</strong> 文脈に合う単語を選択<br>
                    <strong>ミックス:</strong> 全種類の問題をランダムに
                </p>
                <div class="features glass-morphism mt-8 p-5 bg-indigo-100 rounded-xl">
                    <h3 class="text-center text-xl font-semibold mb-4 text-indigo-600">✨ 新機能</h3>
                    <ul class="text-left text-gray-600 leading-relaxed list-disc list-inside">
                        <li>🎯 問題数選択（5/10/30/全て）</li>
                        <li>🔥 連続正解カウンター</li>
                        <li>⏱️ 問題別タイマー</li>
                        <li>🌙 ダークモード対応</li>
                        <li>⌨️ キーボードショートカット</li>
                        <li>📱 完全レスポンシブ対応</li>
                        <li>📚 レッスン選択機能</li>
                        <li>🇨🇳 意味練習で中国語表示</li>
                        <li>✨ AIによる新しい例文生成</li>
                        <li>📖 読方問題で単語クリック例文表示</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="keyboard-shortcut fixed bottom-5 right-5 bg-gray-800 text-white py-2.5 px-4 rounded-xl text-xs opacity-0 transition-opacity duration-300 z-50" id="keyboardHint">
        キーボード: 1-4で選択, Enterで確定
    </div>

    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="messageBoxText" class="text-lg font-semibold mb-4"></p>
            <button class="btn bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-2 px-4 rounded-full" onclick="hideMessageBox()">OK</button>
        </div>
    </div>

    <div id="generatedSentenceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full text-center">
            <h3 class="text-xl font-bold mb-4 text-indigo-700">✨ 新しい例文</h3>
            <p id="generatedSentenceText" class="text-lg text-gray-800 mb-4"></p>
            <div id="sentenceLoadingSpinner" class="hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto"></div>
                <p class="text-gray-600 text-sm mt-2">生成中...</p>
            </div>
            <button class="btn bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-2 px-4 rounded-full" onclick="hideGeneratedSentenceModal()">閉じる</button>
        </div>
    </div>

    <script>
        let allVocabulary = {};
        let currentQuiz = [];
        let currentQuestion = 0;
        let score = 0;
        let selectedAnswer = null;
        let quizMode = 'reading';
        let streak = 0;
        let maxStreak = 0;
        let startTime = null;
        let questionStartTime = null;
        let totalTime = 0;
        let wrongAnswers = [];
        let isDarkMode = false;
        let timerInterval;

        let headerElement;
        let controlsElement;
        let quizContainerElement;
        let mainContainerElement;
        let startQuizButton;
        let lessonSelectElement;

        async function loadVocabularyData() {
            try {
                const response = await fetch('vocabulary.json'); // Make sure vocabulary.json is in the same directory or provide correct path
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allVocabulary = await response.json();
                console.log("Vocabulary loaded successfully:", allVocabulary);
                populateLessonSelect();
                if (startQuizButton) startQuizButton.disabled = false;
            } catch (error) {
                console.error("Could not load vocabulary:", error);
                showMessageBox("語彙データの読み込みに失敗しました。ページを再読み込みするか、vocabulary.jsonファイルを確認してください。");
                if (startQuizButton) startQuizButton.disabled = true;
            }
        }

        function populateLessonSelect() {
            if (!lessonSelectElement) return;
            lessonSelectElement.innerHTML = '<option value="all">全てのレッスン</option>';

            const lessonKeys = Object.keys(allVocabulary);
            lessonKeys.sort((a, b) => {
                const numA = parseInt(a.replace('lesson', ''), 10);
                const numB = parseInt(b.replace('lesson', ''), 10);
                return numA - numB;
            });

            lessonKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key.replace('lesson', 'レッスン');
                lessonSelectElement.appendChild(option);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            headerElement = document.querySelector('.header');
            controlsElement = document.querySelector('.controls');
            quizContainerElement = document.getElementById('quizContainer');
            mainContainerElement = document.querySelector('.container');
            startQuizButton = document.getElementById('startQuizButton');
            lessonSelectElement = document.getElementById('lesson');

            loadVocabularyData();
            const difficultySelect = document.getElementById('difficulty');
            if (difficultySelect) {
                difficultySelect.value = "20";
            }
        });

        function showMessageBox(message) {
            document.getElementById('messageBoxText').textContent = message;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        function hideMessageBox() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        function showGeneratedSentenceModal(sentence) {
            document.getElementById('generatedSentenceText').textContent = sentence;
            document.getElementById('sentenceLoadingSpinner').classList.add('hidden');
            document.getElementById('generatedSentenceModal').classList.remove('hidden');
        }

        function hideGeneratedSentenceModal() {
            document.getElementById('generatedSentenceModal').classList.add('hidden');
            document.getElementById('generatedSentenceText').textContent = '';
        }

        function showSentenceLoadingSpinner() {
            document.getElementById('generatedSentenceText').textContent = '';
            document.getElementById('sentenceLoadingSpinner').classList.remove('hidden');
            document.getElementById('generatedSentenceModal').classList.remove('hidden');
        }

        document.addEventListener('keydown', (e) => {
            if (selectedAnswer !== null || !document.getElementById('messageBox').classList.contains('hidden') || !document.getElementById('generatedSentenceModal').classList.contains('hidden')) {
                return;
            }
            const key = e.key;
            if (key >= '1' && key <= '4') {
                const options = document.querySelectorAll('.option');
                const index = parseInt(key) - 1;
                if (options[index]) {
                    selectAnswer(index);
                }
            } else if (key === 'Enter' && selectedAnswer !== null) {
                submitAnswer();
            }
        });

        function showKeyboardHint() {
            const hint = document.getElementById('keyboardHint');
            hint.classList.add('opacity-100');
            setTimeout(() => {
                hint.classList.remove('opacity-100');
            }, 3000);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function isReadingSameAsWord(vocab) {
            return vocab.word === vocab.reading;
        }

        function generateQuestion(vocab, mode, allAvailableVocab) {
            const correctAnswer = vocab;
            let otherVocab = allAvailableVocab.filter(v => v.word !== vocab.word);
            if (otherVocab.length < 3) {
                const needed = 3 - otherVocab.length;
                for (let i = 0; i < needed; i++) {
                    let randomVocab;
                    do {
                         randomVocab = allAvailableVocab[Math.floor(Math.random() * allAvailableVocab.length)];
                    } while (randomVocab.word === vocab.word || otherVocab.some(ov => ov.word === randomVocab.word));
                    if (randomVocab) otherVocab.push(randomVocab);
                }
                otherVocab = otherVocab.filter(v => v.word !== vocab.word).slice(0,3);
            }

            const wrongAnswersPool = shuffleArray(otherVocab).slice(0, 3);
            while(wrongAnswersPool.length < 3) {
                let randomFallback = allAvailableVocab[Math.floor(Math.random() * allAvailableVocab.length)];
                 if (randomFallback.word !== vocab.word && !wrongAnswersPool.some(w => w.word === randomFallback.word)) {
                     wrongAnswersPool.push(randomFallback);
                 } else if (randomFallback.word !== vocab.word) {
                     wrongAnswersPool.push(randomFallback);
                 } else if (allAvailableVocab.length > 1) {
                     let anotherFallback;
                     do {
                         anotherFallback = allAvailableVocab[Math.floor(Math.random() * allAvailableVocab.length)];
                     } while (anotherFallback.word === vocab.word && allAvailableVocab.length > 1);
                     wrongAnswersPool.push(anotherFallback);
                 } else { 
                    wrongAnswersPool.push({word: "---", reading: "---", chineseMeaning: "---", meaning: "---"});
                 }
            }


            if (mode === 'reading') {
                if (isReadingSameAsWord(vocab)) {
                    console.warn(`Skipping reading question for word where reading is same as word: ${vocab.word}. Falling back to meaning.`);
                    const meaningQuestion = generateQuestion(vocab, 'meaning', allAvailableVocab);
                    if (meaningQuestion) {
                        meaningQuestion.originalIntendedMode = 'reading'; // Add the flag here
                    }
                    return meaningQuestion;
                }
                return {
                    question: vocab.word,
                    options: shuffleArray([
                        { text: correctAnswer.reading, correct: true },
                        { text: wrongAnswersPool[0] ? wrongAnswersPool[0].reading : '---', correct: false },
                        { text: wrongAnswersPool[1] ? wrongAnswersPool[1].reading : '---', correct: false },
                        { text: wrongAnswersPool[2] ? wrongAnswersPool[2].reading : '---', correct: false }
                    ]),
                    correctAnswer: correctAnswer.reading,
                    vocab: vocab,
                    mode: 'reading'
                };
            } else if (mode === 'meaning') {
                const correctMeaning = correctAnswer.chineseMeaning || correctAnswer.meaning;
                const wrongMeaning1 = wrongAnswersPool[0] ? (wrongAnswersPool[0].chineseMeaning || wrongAnswersPool[0].meaning) : '---';
                const wrongMeaning2 = wrongAnswersPool[1] ? (wrongAnswersPool[1].chineseMeaning || wrongAnswersPool[1].meaning) : '---';
                const wrongMeaning3 = wrongAnswersPool[2] ? (wrongAnswersPool[2].chineseMeaning || wrongAnswersPool[2].meaning) : '---';
                return {
                    question: vocab.word + (vocab.word !== vocab.reading ? ' (' + vocab.reading + ')' : ''),
                    options: shuffleArray([
                        { text: correctMeaning, correct: true },
                        { text: wrongMeaning1, correct: false },
                        { text: wrongMeaning2, correct: false },
                        { text: wrongMeaning3, correct: false }
                    ]),
                    correctAnswer: correctMeaning,
                    vocab: vocab,
                    mode: 'meaning'
                };
            } else { // usage mode
                if (!vocab.usage) {
                     console.warn(`Skipping usage question for word: ${vocab.word} (no usage provided). Falling back to meaning.`);
                     return generateQuestion(vocab, 'meaning', allAvailableVocab);
                }
                return {
                    question: vocab.usage,
                    options: shuffleArray([
                        { text: correctAnswer.word, correct: true },
                        { text: wrongAnswersPool[0] ? wrongAnswersPool[0].word : '---', correct: false },
                        { text: wrongAnswersPool[1] ? wrongAnswersPool[1].word : '---', correct: false },
                        { text: wrongAnswersPool[2] ? wrongAnswersPool[2].word : '---', correct: false }
                    ]),
                    correctAnswer: correctAnswer.word,
                    vocab: vocab,
                    mode: 'usage'
                };
            }
        }


        function startQuiz() {
            if (Object.keys(allVocabulary).length === 0) {
                showMessageBox('語彙データがまだ読み込まれていません。少々お待ちいただくか、ページを再読み込みしてください。');
                return;
            }

            if (headerElement) headerElement.classList.add('hidden-during-quiz');
            if (controlsElement) controlsElement.classList.add('hidden-during-quiz');
            document.body.classList.add('quiz-mode-active');
            if (quizContainerElement) quizContainerElement.classList.add('immersive-active');

            const selectedLesson = document.getElementById('lesson').value;
            quizMode = document.getElementById('mode').value;
            const difficulty = document.getElementById('difficulty').value;

            let sourceVocab = [];
            if (selectedLesson === 'all') {
                for (const lessonKey in allVocabulary) {
                    if (allVocabulary.hasOwnProperty(lessonKey) && Array.isArray(allVocabulary[lessonKey])) {
                        sourceVocab = sourceVocab.concat(allVocabulary[lessonKey]);
                    }
                }
            } else {
                if (allVocabulary.hasOwnProperty(selectedLesson) && Array.isArray(allVocabulary[selectedLesson])) {
                    sourceVocab = allVocabulary[selectedLesson];
                } else {
                    showMessageBox(`レッスン "${selectedLesson}" の単語が見つかりません。vocabulary.json を確認してください。`);
                    resetQuizInterface();
                    return;
                }
            }

            if (sourceVocab.length === 0) {
                showMessageBox('選択されたレッスンには単語がありません。');
                resetQuizInterface();
                return;
            }
            sourceVocab = sourceVocab.filter(item => typeof item === 'object' && item !== null && item.word);


            let questionCount;
            if (difficulty === 'all') {
                questionCount = sourceVocab.length;
            } else {
                questionCount = parseInt(difficulty);
            }

            if (sourceVocab.length < questionCount && difficulty !== 'all') {
                showMessageBox(`選択されたレッスンには ${sourceVocab.length} 個の単語しかありません。問題数を調整しました。`);
                questionCount = sourceVocab.length;
            }
            if (questionCount === 0 && sourceVocab.length > 0) {
                questionCount = Math.min(10, sourceVocab.length);
            }
             if (questionCount === 0) { 
                 showMessageBox('問題数が0です。問題数を選択してください。');
                 resetQuizInterface();
                 return;
             }


            const shuffledVocabForQuiz = shuffleArray(sourceVocab).slice(0, questionCount);

            let generatedQuestions = [];
            const modes = ['reading', 'meaning', 'usage'];

            for (const vocab of shuffledVocabForQuiz) {
                let question = null;
                if (quizMode === 'mixed') {
                    const shuffledModes = shuffleArray([...modes]);
                    for (const mode of shuffledModes) {
                        question = generateQuestion(vocab, mode, sourceVocab);
                        if (question) break; 
                    }
                } else {
                    question = generateQuestion(vocab, quizMode, sourceVocab);
                }
                 if (question) {
                     generatedQuestions.push(question);
                 } else {
                     console.warn(`Could not generate a valid question for vocab: ${vocab.word} in mode: ${quizMode}`);
                 }
            }

            currentQuiz = generatedQuestions;


            if (currentQuiz.length === 0) {
                showMessageBox('選択された条件で問題を作成できませんでした。別のモードまたはレッスンを試してください。');
                resetQuiz();
                return;
            }

            currentQuestion = 0;
            score = 0;
            streak = 0;
            maxStreak = 0;
            wrongAnswers = [];
            selectedAnswer = null;
            startTime = Date.now();
            totalTime = 0;

            showKeyboardHint();
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestion >= currentQuiz.length) {
                showFinalScore();
                return;
            }

            const question = currentQuiz[currentQuestion];
            const container = quizContainerElement;
            questionStartTime = Date.now();

            // Prepare question text (animation removed) and example sentence display
            let questionTextHTML = `<div class="question text-2xl md:text-3xl mb-1 md:mb-2 font-semibold text-center text-gray-900 leading-tight" id="questionText">${question.question}</div>`;
            let exampleSentenceHTML = `<div id="exampleSentenceDisplay" class="text-center text-gray-700 dark:text-gray-300 mt-2 mb-4 text-lg px-2" style="display: none; word-break: normal; line-height: 1.6;"></div>`;


            container.innerHTML = `
                <button class="exit-btn" onclick="resetQuiz()">✕</button>
                <div class="progress-container mb-4 md:mb-8">
                    <div class="progress-info flex justify-between mb-2 font-semibold text-indigo-600">
                        <span>${currentQuestion + 1} / ${currentQuiz.length}</span>
                        <span>進捗: ${Math.round((currentQuestion / currentQuiz.length) * 100)}%</span>
                    </div>
                    <div class="progress-bar w-full h-2.5 bg-indigo-200 rounded-md overflow-hidden relative">
                        <div class="progress-fill h-full bg-gradient-to-r from-indigo-500 to-purple-600 rounded-md transition-all duration-500 ease-in-out relative" style="width: ${(currentQuestion / currentQuiz.length) * 100}%"></div>
                    </div>
                </div>
                <div class="stats flex justify-between mb-3 md:mb-5 text-sm md:text-lg font-semibold flex-wrap gap-2">
                    <span class="score text-green-600 flex items-center gap-1 md:gap-2">✅ 正解: ${score}</span>
                    <span class="streak-counter text-red-500 flex items-center gap-1 md:gap-2">🔥 連続: ${streak}</span>
                    <span class="timer text-orange-500 flex items-center gap-1 md:gap-2">⏱️ 経過: <span id="timer">0</span>s</span>
                </div>
                
                <div class="question-area-wrapper">
                    <div class="question-content-area">
                        ${questionTextHTML}
                        ${exampleSentenceHTML}
                    </div>
                </div>

                <div class="options grid gap-3 md:gap-4 mb-0">
                    ${question.options.map((option, index) => `
                        <button class="option relative overflow-hidden bg-white bg-opacity-80 border-2 border-indigo-300 p-3 md:p-5 rounded-xl cursor-pointer transition-all duration-300 text-base md:text-lg text-center hover:bg-indigo-50 hover:border-indigo-500 hover:translate-y-[-3px] hover:shadow-lg" onclick="selectAnswer(${index})" data-index="${index}">
                            <span class="text-indigo-500 font-bold mr-2">${index + 1}.</span>
                            ${option.text}
                        </button>
                    `).join('')}
                </div>
                <div class="feedback text-center text-lg md:text-xl font-semibold"></div>
            `;

            const feedbackElement = container.querySelector('.feedback');
            if (feedbackElement) {
                feedbackElement.style.visibility = 'hidden';
                feedbackElement.innerHTML = '';
            }

            const questionTextElement = document.getElementById('questionText');
            const exampleSentenceDisplayElement = document.getElementById('exampleSentenceDisplay');

            // Allow clicking for example sentence if:
            // 1. It's a genuine 'reading' mode question, OR
            // 2. The original intent was 'reading' (even if it fell back to 'meaning' mode), AND
            // 3. The vocab and exampleSentence exist.
            const canShowExampleOnClick = (question.mode === 'reading' || question.originalIntendedMode === 'reading') &&
                                          question.vocab && question.vocab.exampleSentence;

            if (questionTextElement && exampleSentenceDisplayElement && canShowExampleOnClick) {
                questionTextElement.style.cursor = 'pointer';
                questionTextElement.title = 'クリックして例文を表示/非表示'; // Tooltip

                questionTextElement.onclick = () => {
                    if (selectedAnswer !== null) return; 
                    
                    if (exampleSentenceDisplayElement.style.display === 'none' || exampleSentenceDisplayElement.textContent !== question.vocab.exampleSentence) {
                        exampleSentenceDisplayElement.textContent = question.vocab.exampleSentence;
                        exampleSentenceDisplayElement.style.display = 'block';
                    } else {
                        exampleSentenceDisplayElement.style.display = 'none';
                    }
                };
            }
            updateTimer();
        }

        function updateTimer() {
            clearInterval(timerInterval);
            if (currentQuestion >= currentQuiz.length || selectedAnswer !== null) return;

            const timerElement = document.getElementById('timer');
            if (timerElement && questionStartTime) {
                const update = () => {
                    if (selectedAnswer !== null || currentQuestion >= currentQuiz.length) {
                        clearInterval(timerInterval);
                        return;
                    }
                    const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                    timerElement.textContent = elapsed;
                };
                update();
                timerInterval = setInterval(update, 1000);
            }
        }

        function selectAnswer(index) {
            if (selectedAnswer !== null) return;
            selectedAnswer = index;
            clearInterval(timerInterval);

            const exampleSentenceDisplayElement = document.getElementById('exampleSentenceDisplay');
            if (exampleSentenceDisplayElement) {
                exampleSentenceDisplayElement.style.display = 'none';
            }

            document.querySelectorAll('.option').forEach((option, i) => {
                option.classList.remove('bg-gradient-to-br', 'from-indigo-500', 'to-purple-600', 'text-white', 'border-indigo-500', 'scale-105');
                if (i === index) {
                    option.classList.add('bg-gradient-to-br', 'from-indigo-500', 'to-purple-600', 'text-white', 'border-indigo-500', 'scale-105');
                }
            });
            setTimeout(() => { submitAnswer(); }, 300);
        }

        function submitAnswer() {
            if (selectedAnswer === null) return;

            const question = currentQuiz[currentQuestion];
            const isCorrect = question.options[selectedAnswer].correct;
            const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
            totalTime += timeSpent;

            if (isCorrect) {
                score++;
                streak++;
                if (streak > maxStreak) maxStreak = streak;
            } else {
                streak = 0;
                wrongAnswers.push({
                    question: question.question,
                    yourAnswer: question.options[selectedAnswer].text,
                    correctAnswer: question.correctAnswer,
                    questionNumber: currentQuestion + 1,
                    vocab: question.vocab,
                    timeSpent: timeSpent,
                    mode: question.mode
                });
            }

            document.querySelectorAll('.option').forEach((option, i) => {
                option.classList.remove('bg-gradient-to-br', 'from-indigo-500', 'to-purple-600', 'text-white', 'border-indigo-500', 'scale-105');
                if (question.options[i].correct) {
                    option.classList.add('bg-gradient-to-br', 'from-green-500', 'to-lime-600', 'text-white', 'border-green-500', 'animate-[correctPulse_0.6s_ease]');
                } else if (i === selectedAnswer && !isCorrect) {
                    option.classList.add('bg-gradient-to-br', 'from-red-500', 'to-orange-500', 'text-white', 'border-red-500', 'animate-[incorrectShake_0.6s_ease]');
                }
                option.style.pointerEvents = 'none';
            });

            const feedbackElement = document.querySelector('.feedback');
            feedbackElement.className = `feedback text-center text-lg md:text-xl font-semibold p-3 md:p-4 rounded-lg ${isCorrect ? 'text-green-600 bg-green-50 border-2 border-green-200' : 'text-red-600 bg-red-50 border-2 border-red-200'}`;

            let feedbackText = isCorrect ? `🎉 正解！ (${timeSpent}秒)` : `❌ 不正解。正解は“${question.correctAnswer}”。`;
            if (!isCorrect && question.vocab) {
                const displayMeaning = question.vocab.chineseMeaning || question.vocab.meaning;
                feedbackText += `<br><small class="text-gray-600 dark:text-slate-400 opacity-90 dark:opacity-85 text-sm md:text-base">
                    ${question.vocab.word} ${question.vocab.word !== question.vocab.reading ? '('+question.vocab.reading+')' : ''} - ${displayMeaning}
                    ${question.vocab.exampleSentence ? `<br>例文: ${question.vocab.exampleSentence}` : ''}
                </small>`;
            }
            feedbackElement.innerHTML = feedbackText;

            if (feedbackElement) {
                feedbackElement.style.visibility = 'visible';
            }

            const delay = isCorrect ? 1500 : 3000;
            setTimeout(() => {
                nextQuestion();
            }, delay);
        }

        function nextQuestion() {
            currentQuestion++;
            selectedAnswer = null;
            showQuestion();
        }

        function resetQuizInterface() {
            if (headerElement) headerElement.classList.remove('hidden-during-quiz');
            if (controlsElement) controlsElement.classList.remove('hidden-during-quiz');
            document.body.classList.remove('quiz-mode-active');
            if (quizContainerElement) {
                quizContainerElement.classList.remove('immersive-active');
                quizContainerElement.style.paddingTop = '';
                quizContainerElement.style.paddingBottom = '';
                quizContainerElement.style.paddingLeft = '';
                quizContainerElement.style.paddingRight = '';
            }
        }

        function showFinalScore() {
            resetQuizInterface();
            clearInterval(timerInterval);
            totalTime = Math.floor((Date.now() - startTime) / 1000);
            const percentage = currentQuiz.length > 0 ? Math.round((score / currentQuiz.length) * 100) : 0;
            const avgTime = currentQuiz.length > 0 ? Math.round(totalTime / currentQuiz.length) : 0;

            let message = '';
            let emoji = '';
            if (percentage >= 90) {
                message = '素晴らしい！';
                emoji = '🏆';
            } else if (percentage >= 70) {
                message = 'よくできました！';
                emoji = '🎉';
            } else if (percentage >= 50) {
                message = 'もう少し頑張りましょう。';
                emoji = '💪';
            } else {
                message = '復習が必要です。';
                emoji = '📚';
            }

            let wrongAnswersHtml = '';
            if (wrongAnswers.length > 0) {
                wrongAnswersHtml = `
                    <div class="wrong-answers-section mt-8 text-left animate-[slideUp_0.8s_ease]">
                        <h3 class="text-center text-2xl font-bold mb-5 text-red-600">${emoji} 復習が必要な単語 (${wrongAnswers.length}個)</h3>
                        <div class="wrong-answers-list max-h-80 overflow-y-auto bg-red-50 dark:bg-red-900 dark:bg-opacity-30 rounded-lg p-5 border border-red-200 dark:border-red-700">
                            ${wrongAnswers.map(wrong => `
                                <div class="wrong-answer-item mb-4 p-4 bg-white dark:bg-gray-700 rounded-lg border-l-4 border-red-500 shadow-md transition-transform duration-200 hover:translate-x-1">
                                    <div class="font-bold mb-2 text-gray-900 dark:text-gray-100 text-lg">問題${wrong.questionNumber}: ${wrong.question}</div>
                                    <div class="text-red-600 dark:text-red-400 mb-1 flex items-center gap-2">❌ あなたの回答: ${wrong.yourAnswer} <span class="bg-red-500 text-white py-0.5 px-2 rounded-full text-xs">${wrong.timeSpent}秒</span></div>
                                    <div class="text-green-600 dark:text-green-400 mb-2">✅ 正解: ${wrong.correctAnswer}</div>
                                    ${wrong.vocab ? `<div class="bg-indigo-100 dark:bg-indigo-900 dark:bg-opacity-40 p-2 rounded-md text-sm text-gray-700 dark:text-gray-300">
                                        <strong>${wrong.vocab.word}</strong> ${wrong.vocab.word !== wrong.vocab.reading ? '('+wrong.vocab.reading+')' : ''}<br>
                                        意味: ${wrong.vocab.chineseMeaning || wrong.vocab.meaning}<br>
                                        元々の例文: ${wrong.vocab.usage || 'なし'}<br>
                                        ${wrong.vocab.exampleSentence ? `収録例文: ${wrong.vocab.exampleSentence}<br>` : ''}
                                        <button class="generate-sentence-btn mt-2 px-3 py-1.5 bg-blue-500 text-white text-sm rounded-full hover:bg-blue-600 transition-colors duration-200" onclick="generateExampleSentence(this, '${wrong.vocab.word.replace(/'/g, "\\'")}', '${wrong.vocab.reading.replace(/'/g, "\\'")}', '${(wrong.vocab.chineseMeaning || wrong.vocab.meaning).replace(/'/g, "\\'")}')">✨ 新しい例文を生成</button>
                                    </div>` : ''}
                                </div>`).join('')}
                        </div>
                    </div>`;
            }

            quizContainerElement.innerHTML = `
                <div class="final-score text-center text-gray-900 dark:text-gray-100 text-3xl font-bold my-8 animate-[fadeIn_1s_ease]"> <!-- Changed to fadeIn -->
                    <h2 class="text-4xl">${emoji} ${message}</h2>
                    <div class="text-indigo-600 dark:text-indigo-400 my-5 text-2xl">${score} / ${currentQuiz.length} 正解</div>
                    <div class="text-gray-600 dark:text-gray-400 text-xl mb-5">正答率: ${percentage}%</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-8 text-base">
                        <div class="bg-green-50 dark:bg-green-900 dark:bg-opacity-30 p-4 rounded-lg text-center"><div class="text-green-600 dark:text-green-400 font-bold">🔥 最高連続正解</div><div class="text-2xl font-bold">${maxStreak}</div></div>
                        <div class="bg-orange-50 dark:bg-orange-900 dark:bg-opacity-30 p-4 rounded-lg text-center"><div class="text-orange-600 dark:text-orange-400 font-bold">⏱️ 総時間</div><div class="text-2xl font-bold">${Math.floor(totalTime / 60)}:${(totalTime % 60).toString().padStart(2, '0')}</div></div>
                        <div class="bg-indigo-50 dark:bg-indigo-900 dark:bg-opacity-30 p-4 rounded-lg text-center"><div class="text-indigo-600 dark:text-indigo-400 font-bold">📊 平均時間</div><div class="text-2xl font-bold">${avgTime}秒</div></div>
                    </div>
                    ${wrongAnswersHtml}
                    <div class="flex gap-4 justify-center mt-8 flex-wrap">
                        <button class="btn relative overflow-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0" onclick="startQuiz()">もう一度</button>
                        <button class="btn secondary relative overflow-hidden bg-gradient-to-br from-red-500 to-orange-500 text-white font-semibold py-3 px-6 rounded-full cursor-pointer text-base shadow-lg transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl active:translate-y-0 ${wrongAnswers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" onclick="reviewWrongAnswers()" ${wrongAnswers.length === 0 ? 'disabled' : ''}>復習モード</button>
                    </div>
                </div>`;
            // Small correction: Final score animation changed from 'scoreReveal' (which wasn't defined) to 'fadeIn' for consistency.
        }

        function reviewWrongAnswers() {
            if (wrongAnswers.length === 0) {
                showMessageBox('復習する問題がありません！');
                return;
            }

            if (headerElement) headerElement.classList.add('hidden-during-quiz');
            if (controlsElement) controlsElement.classList.add('hidden-during-quiz');
            document.body.classList.add('quiz-mode-active');
            if (quizContainerElement) quizContainerElement.classList.add('immersive-active');

            let allCombinedVocab = [];
            for (const lessonKey in allVocabulary) {
                if (allVocabulary.hasOwnProperty(lessonKey) && Array.isArray(allVocabulary[lessonKey])) {
                    allCombinedVocab = allCombinedVocab.concat(allVocabulary[lessonKey]);
                }
            }
            if (allCombinedVocab.length === 0) {
                allCombinedVocab = wrongAnswers.map(w => w.vocab).filter(Boolean);
            }
            allCombinedVocab = allCombinedVocab.filter(item => typeof item === 'object' && item !== null && item.word);


            currentQuiz = wrongAnswers.map(wrong => {
                const vocab = wrong.vocab;
                if (!vocab || typeof vocab.word === 'undefined') {
                    console.error("Invalid vocab item in wrongAnswers:", wrong);
                    return null;
                }
                const modes = ['reading', 'meaning', 'usage'];
                const reviewMode = wrong.mode && modes.includes(wrong.mode) ? wrong.mode : modes[Math.floor(Math.random() * modes.length)];
                const vocabSourceForOptions = allCombinedVocab.length > 0 ? allCombinedVocab : [vocab]; 
                return generateQuestion(vocab, reviewMode, vocabSourceForOptions);
            }).filter(Boolean); 


            if (currentQuiz.length === 0) {
                showMessageBox('復習問題の作成に失敗しました。');
                resetQuiz();
                return;
            }

            currentQuestion = 0;
            score = 0;
            streak = 0;
            maxStreak = 0;
            selectedAnswer = null;
            startTime = Date.now();
            totalTime = 0;
            wrongAnswers = []; 

            showQuestion();
        }

        function resetQuiz() {
            resetQuizInterface();
            clearInterval(timerInterval);
            quizContainerElement.innerHTML = `
                <div class="welcome-message">
                    <h2 class="text-center text-2xl font-bold mb-5">練習モードを選んで開始してください</h2>
                    <p class="text-center text-gray-600 dark:text-gray-300 text-lg mb-8">
                        <strong>読み方:</strong> 漢字の読みを選択 (クリックで例文表示)<br>
                        <strong>意味:</strong> 単語の意味を選択<br>
                        <strong>使い方:</strong> 文脈に合う単語を選択<br>
                        <strong>ミックス:</strong> 全種類の問題をランダムに
                    </p>
                    <div class="features glass-morphism mt-8 p-5 bg-indigo-100 dark:bg-indigo-900 dark:bg-opacity-40 rounded-xl">
                        <h3 class="text-center text-xl font-semibold mb-4 text-indigo-600 dark:text-indigo-400">✨ 新機能</h3>
                        <ul class="text-left text-gray-600 dark:text-gray-300 leading-relaxed list-disc list-inside">
                            <li>🎯 問題数選択（5/10/30/全て）</li>
                            <li>🔥 連続正解カウンター</li>
                            <li>⏱️ 問題別タイマー</li>
                            <li>🌙 ダークモード対応</li>
                            <li>⌨️ キーボードショートカット</li>
                            <li>📱 完全レスポンシブ対応</li>
                            <li>📚 レッスン選択機能</li>
                            <li>🇨🇳 意味練習で中国語表示</li>
                            <li>✨ AIによる新しい例文生成</li>
                            <li>📖 読方問題で単語クリック例文表示</li>
                        </ul>
                    </div>
                </div>`;
            currentQuiz = [];
            currentQuestion = 0;
            score = 0;
            selectedAnswer = null;
            streak = 0;
            maxStreak = 0;
            startTime = null;
            questionStartTime = null;
            totalTime = 0;
            wrongAnswers = [];
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            if (isDarkMode) {
                body.classList.add('dark-mode');
                body.classList.remove('text-gray-800');
                button.textContent = '☀️';
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('text-gray-800'); 
                button.textContent = '🌙';
            }
        }

        async function generateExampleSentence(buttonElement, word, reading, meaning) {
            buttonElement.disabled = true;
            buttonElement.textContent = '生成中...';
            showSentenceLoadingSpinner();

            let chatHistory = [{ role: "user", parts: [{ text: `「${word} (${reading})」という日本語の単語（意味：${meaning}）を使って、JLPT N3/N2レベルの自然な例文を一つ生成してください。**例文のみを日本語で提供し、説明や他のテキストは一切含めないでください。**` }] }];
            const payload = { contents: chatHistory };
            const apiKey = "YOUR_GEMINI_API_KEY"; 

            if (apiKey === "YOUR_GEMINI_API_KEY" || apiKey === "") {
                showGeneratedSentenceModal('APIキーが設定されていません。');
                console.error('Gemini API key is not set.');
                buttonElement.disabled = false;
                buttonElement.innerHTML = '✨ 新しい例文を生成';
                const sentenceModal = document.getElementById('generatedSentenceModal');
                const spinner = document.getElementById('sentenceLoadingSpinner');
                if (spinner) spinner.classList.add('hidden');
                return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ error: { message: 'Unknown API error format.' } }));
                    console.error('Gemini API error response:', errorResult);
                    throw new Error(`Gemini API request failed: ${response.status} ${response.statusText}. ${errorResult.error?.message || ''}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const sentence = result.candidates[0].content.parts[0].text.trim();
                    showGeneratedSentenceModal(sentence);
                } else {
                    showGeneratedSentenceModal('例文の生成に失敗しました。APIからの応答形式が予期しないものです。');
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                showGeneratedSentenceModal(`例文の生成中にエラーが発生しました。`);
                console.error('Error calling Gemini API:', error);
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = '✨ 新しい例文を生成';
            }
        }
    </script>
</body>
</html>